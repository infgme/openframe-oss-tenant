apiVersion: batch/v1
kind: Job
metadata:
  name: fleetmdm-mysql-init-privileges
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: init-privileges
          image: {{ .Values.mysql.image.registry }}/{{ .Values.mysql.image.repository }}:{{ .Values.mysql.image.tag }}
          env:
            - name: MYSQL_USER
              valueFrom:
                configMapKeyRef:
                  name: fleetmdm-mysql
                  key: MYSQL_USER
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: fleetmdm-mysql
                  key: MYSQL_ROOT_PASSWORD
            - name: FLEET_MYSQL_HOST
              valueFrom:
                configMapKeyRef:
                  name: fleetmdm-mysql
                  key: FLEET_MYSQL_HOST
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for MySQL to be ready..."
              until mysql -h ${FLEET_MYSQL_HOST} -u root -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1" 2>/dev/null; do
                echo "Still waiting for MySQL..."
                sleep 5
              done
              
              echo "Granting Debezium privileges to ${MYSQL_USER}..."
              mysql -h ${FLEET_MYSQL_HOST} -u root -p${MYSQL_ROOT_PASSWORD} -e "GRANT RELOAD, FLUSH_TABLES, REPLICATION CLIENT, REPLICATION SLAVE ON *.* TO '${MYSQL_USER}'@'%'; FLUSH PRIVILEGES;"
              
              echo "Verifying privileges..."
              mysql -h ${FLEET_MYSQL_HOST} -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW GRANTS FOR '${MYSQL_USER}'@'%';"
              
              echo "MySQL user privileges configured successfully."
